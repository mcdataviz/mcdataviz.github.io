<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil de Actividad Bancaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="dashboard" class="max-w-5xl mx-auto p-4 space-y-6">
      <h1 class="text-2xl font-bold">Perfil de actividad</h1>

      <div id="topCards" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h3 class="text-lg font-semibold mb-2">Histograma horario</h3>
          <canvas id="hourChart" class="bg-white p-2 rounded" height="200"></canvas>
        </div>
        <div>
          <div class="flex items-center mb-2">
            <h3 class="text-lg font-semibold">% Outliers (Z≥3.5)</h3>
            <button
              id="outlierInfo"
              title="Porcentaje de montos atípicos (z≥3.5)"
              class="ml-2 text-gray-500 hover:text-gray-700"
            >
              <svg
                class="w-5 h-5"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"
                />
              </svg>
            </button>
          </div>
          <canvas
            id="outlierGauge"
            class="bg-white p-2 rounded"
            height="200"
          ></canvas>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-lg font-semibold mb-4">Métricas de montos</h3>
          <canvas id="amountMetricsChart" height="200"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Recencia</h3>
          <canvas
            id="recencyHist"
            class="bg-white p-2 rounded"
            height="200"
          ></canvas>
        </div>
      </div>

      <div id="otherCards" class="grid md:grid-cols-3 gap-4"></div>
    </div>

    <script>
      // Parse JSON from query param 'p'
      let data = {};
      try {
        const params = new URLSearchParams(window.location.search);
        const p = params.get("p");
        if (p) {
          data = JSON.parse(decodeURIComponent(p));
        }
      } catch (e) {
        console.error("Error parsing data", e);
      }

      const LABELS = {
        tier: "Tier por volumen (1=alto, 5=bajo)",
        totals: {
          n_trx: "Operaciones (90 días) (#)",
          sum_in: "Ingresos ($)",
          sum_out: "Egresos ($)",
          net: "Neto ($)",
          median_abs: "Mediana de monto ($)",
          mad_abs: "MAD (desvío abs. mediano) ($)",
          "frac_outlier_z>=3.5": "% outliers (z robusto ≥ 3.5) (%)",
          max_abs: "Monto máximo ($)",
          p95_abs: "P95 de monto ($)",
          p99_abs: "P99 de monto ($)",
        },
        robust_stats: {
          median_abs: "Mediana de monto ($)",
          mad_abs: "MAD ($)",
          "frac_outlier_z>=3.5": "% outliers robustos (%)",
        },
        velocity: {
          max_cnt_5m: "Máx. ops en 5 min (#)",
          max_cnt_30m: "Máx. ops en 30 min (#)",
          max_cnt_60m: "Máx. ops en 60 min (#)",
          max_cnt_24h: "Máx. ops en 24 h (#)",
        },
        recency: {
          mean_delta_s: "Δt promedio entre ops (seg)",
          median_delta_s: "Δt mediano (seg)",
          p05_delta_s: "Δt P5 (seg)",
          p95_delta_s: "Δt P95 (seg)",
          min_delta_s: "Δt mínimo (seg)",
          max_delta_s: "Δt máximo (seg)",
        },
        novelty: {
          first_time_cbu_frac: "% CBUs nuevos (%)",
          first_time_cuit_frac: "% CUITs nuevos (%)",
          rare_cbu_frac: "% CBUs raros (<2 tx) (%)",
          rare_cuit_frac: "% CUITs raros (<2 tx) (%)",
          new_cbu_count: "CBUs nuevos (#)",
          new_cuit_count: "CUITs nuevos (#)",
        },
        temporal: {
          hour_jsd_vs_uniform: "Desvío horario vs uniforme (JSD) (0–~0.7)",
          hour_peak_ratio: "% en hora pico (% del total en la hora más activa)",
          weekend_frac: "% en fin de semana (%)",
        },
        roundness: {
          pct_amt_mod_100_eq_0: "% montos múltiplos de $100 (%)",
          pct_amt_mod_1000_eq_0: "% montos múltiplos de $1.000 (%)",
          last_digit_hist: "Último dígito del monto (histograma 0–9)",
        },
        streaks: {
          max_in_30m: "Racha IN en 30 min (máx) (#)",
          max_out_30m: "Racha OUT en 30 min (máx) (#)",
          alternation_rate: "Tasa de alternancia IN↔OUT (0–1)",
        },
        location: {
          unique_checkout: "Checkouts únicos (#)",
          checkout_changes: "Cambios de checkout (#)",
          unique_branch: "Sucursales únicas (#)",
          branch_changes: "Cambios de sucursal (#)",
        },
        duplicates: {
          dup_close_10min_count: "Duplicados ≤10 min (#)",
        },
        status: {
          fail_ratio_overall: "% operaciones fallidas (%)",
          max_fail_ratio_24h: "Máx. % fallidas en 24 h (%)",
        },
        flow: {
          n_in: "Operaciones IN (#)",
          n_out: "Operaciones OUT (#)",
          in_ratio_count: "% IN por cantidad (%)",
          in_ratio_amount: "% IN por monto (%)",
        },
        coherence: {
          dir_unknown_count: "Operaciones sin dirección (#)",
          dir_coverage: "Cobertura de dirección (0–1)",
          in_ratio_count_dir: "IN% (cantidad) por direction (%)",
          in_ratio_count_type: "IN% (cantidad) por tipo (%)",
          in_ratio_count_diff: "Δ IN% (cantidad) dir vs tipo (pp)",
          in_ratio_amount_dir: "IN% (monto) por direction (%)",
          in_ratio_amount_type: "IN% (monto) por tipo (%)",
          in_ratio_amount_diff: "Δ IN% (monto) dir vs tipo (pp)",
          n_rows_used_for_type: "Filas con tipo mapeable (#)",
        },
      };

      function formatNumber(num) {
        if (typeof num === "number") {
          return num.toLocaleString("es-AR", { maximumFractionDigits: 2 });
        }
        if (typeof num === "object") {
          return JSON.stringify(num);
        }
        return num;
      }

      const ICONS = {
        operaciones:
          "<path stroke-linecap='round' stroke-linejoin='round' d='M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z' />",
        ingresos:
          "<path stroke-linecap='round' stroke-linejoin='round' d='m9 12.75 3 3m0 0 3-3m-3 3v-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z' />",
        egresos:
          "<path stroke-linecap='round' stroke-linejoin='round' d='m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z' />",
        neto:
          "<path stroke-linecap='round' stroke-linejoin='round' d='M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 0 1-2.031.352 5.988 5.988 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971Zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 0 1-2.031.352 5.989 5.989 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971Z' />",
      };

      function addTopCard(containerId, label, value, icon, color) {
        const container = document.getElementById(containerId);
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow flex items-center";
        card.innerHTML =
          `<svg class='w-8 h-8 ${color} mr-3' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' xmlns='http://www.w3.org/2000/svg'>${icon}</svg>` +
          `<div><p class='text-sm text-gray-500'>${label}</p><p class='text-lg font-semibold'>${formatNumber(value)}</p></div>`;
        container.appendChild(card);
      }

      function addCard(containerId, title, obj, labels = {}) {
        const entries = Object.entries(obj || {});
        if (!entries.length) return;
        const container = document.getElementById(containerId);
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow";
        let html = `<h5 class="text-lg font-semibold mb-2">${title}</h5>`;
        html += entries
          .map(
            ([k, v]) =>
              `<p class='text-sm'><span class='font-medium'>${labels[k] || k}:</span> ${formatNumber(v)}</p>`,
          )
          .join("");
        card.innerHTML = html;
        container.appendChild(card);
      }

      if (data.tier != null) {
        const dashboard = document.getElementById("dashboard");
        const h1 = dashboard.querySelector("h1");
        const p = document.createElement("p");
        p.innerHTML = `<strong>${LABELS.tier}:</strong> ${formatNumber(data.tier)}`;
        h1.insertAdjacentElement("afterend", p);
      }

      if (data.totals) {
        addTopCard(
          "topCards",
          "Operaciones",
          data.totals.n_trx,
          ICONS.operaciones,
          "text-blue-500",
        );
        addTopCard(
          "topCards",
          "Ingresos",
          data.totals.sum_in,
          ICONS.ingresos,
          "text-green-500",
        );
        addTopCard(
          "topCards",
          "Egresos",
          data.totals.sum_out,
          ICONS.egresos,
          "text-red-500",
        );
        addTopCard("topCards", "Neto", data.totals.net, ICONS.neto, "text-gray-500");

        const metrics = ["median_abs", "mad_abs", "max_abs", "p95_abs", "p99_abs"];
        const labels = metrics.map((m) => LABELS.totals[m]);
        const values = metrics.map((m) => data.totals[m]);
        const ctx = document.getElementById("amountMetricsChart");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                data: values,
                backgroundColor: "#3b82f6",
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
      }

      if (data.temporal && data.temporal.hour_hist) {
        const hist = data.temporal.hour_hist;
        const hours = Object.keys(hist)
          .map((h) => parseInt(h))
          .sort((a, b) => a - b);
        const counts = hours.map((h) => hist[h]);
        const hourCtx = document.getElementById("hourChart");
        new Chart(hourCtx, {
          type: "bar",
          data: {
            labels: hours,
            datasets: [
              {
                label: "Operaciones",
                data: counts,
                backgroundColor: "#0d6efd",
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
      }

      if (data.totals && data.totals["frac_outlier_z>=3.5"] != null) {
        const val = data.totals["frac_outlier_z>=3.5"] * 100;
        const gaugeCtx = document.getElementById("outlierGauge");
        new Chart(gaugeCtx, {
          type: "doughnut",
          data: {
            datasets: [
              {
                data: [val, 100 - val],
                backgroundColor: ["#ef4444", "#e5e7eb"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            rotation: -Math.PI,
            circumference: Math.PI,
            cutout: "70%",
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
              title: { display: true, text: val.toFixed(1) + "%" },
            },
          },
        });
      }

      if (data.recency && data.recency.delta_hist) {
        const hist = data.recency.delta_hist;
        const bins = Object.keys(hist)
          .map((b) => parseInt(b))
          .sort((a, b) => a - b);
        const counts = bins.map((b) => hist[b]);
        const recCtx = document.getElementById("recencyHist");
        new Chart(recCtx, {
          type: "bar",
          data: {
            labels: bins,
            datasets: [
              {
                data: counts,
                backgroundColor: "#10b981",
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
        delete data.recency.delta_hist;
      }

      document
        .getElementById("outlierInfo")
        .addEventListener("click", () =>
          alert(
            "Porcentaje de montos considerados atípicos usando z-score robusto ≥ 3.5",
          ),
        );

      if (data.temporal) {
        const temporalData = { ...data.temporal };
        delete temporalData.hour_hist;
        addCard("otherCards", "Temporal", temporalData, LABELS.temporal);
      }

      if (data.robust_stats)
        addCard(
          "otherCards",
          "Estadísticas robustas",
          data.robust_stats,
          LABELS.robust_stats,
        );
      if (data.velocity)
        addCard("otherCards", "Velocidad", data.velocity, LABELS.velocity);
      if (data.recency)
        addCard("otherCards", "Recencia", data.recency, LABELS.recency);
      if (data.novelty)
        addCard("otherCards", "Novedad", data.novelty, LABELS.novelty);
      if (data.type_freq)
        addCard("otherCards", "Frecuencia por tipo", data.type_freq);
      if (data.type_group_freq)
        addCard(
          "otherCards",
          "Frecuencia por grupo de tipo",
          data.type_group_freq,
        );
      if (data.roundness)
        addCard("otherCards", "Redondez", data.roundness, LABELS.roundness);
      if (data.streaks)
        addCard("otherCards", "Rachas", data.streaks, LABELS.streaks);
      if (data.location)
        addCard("otherCards", "Ubicación", data.location, LABELS.location);
      if (data.flow) addCard("otherCards", "Flujo", data.flow, LABELS.flow);
      if (data.coherence)
        addCard("otherCards", "Coherencia", data.coherence, LABELS.coherence);
      if (data.status)
        addCard("otherCards", "Estado", data.status, LABELS.status);
      if (data.duplicates)
        addCard("otherCards", "Duplicados", data.duplicates, LABELS.duplicates);
    </script>
  </body>
</html>
