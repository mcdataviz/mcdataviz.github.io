<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil de Actividad Bancaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS@1.3.7/dist/gauge.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="dashboard" class="max-w-5xl mx-auto p-4 space-y-6">
      <h1 class="text-2xl font-bold">Perfil de actividad</h1>

      <div class="md:grid md:grid-cols-5 gap-4">
        <aside id="sidebar" class="md:col-span-1 mb-4 md:mb-0">
          <nav id="sidebarNav" class="bg-white rounded shadow overflow-hidden"></nav>
        </aside>
        <div id="content" class="md:col-span-4 space-y-6">

      <div id="topCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 sec-general"></div>

      <div class="bg-white p-4 rounded shadow sec-general">
        <h3 class="text-lg font-semibold mb-4">Escala robusta</h3>
        <div class="h-24">
          <canvas id="robustBullet"></canvas>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 sec-general">
        <div>
          <h3 class="text-lg font-semibold mb-2">Histograma horario</h3>
          <canvas id="hourChart" class="bg-white p-2 rounded" height="200"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Ráfagas por ventana</h3>
          <canvas id="velocityBurstChart" class="bg-white p-2 rounded" height="200"></canvas>
        </div>
      </div>

      <div class="sec-general">
        <h3 class="text-lg font-semibold mb-2">Recencia</h3>
        <div
          id="recencyBullet"
          class="bg-white p-2 rounded w-full h-48"
        ></div>
      </div>

      <div class="grid md:grid-cols-3 gap-4 sec-general">
        <div>
          <h3 class="text-lg font-semibold mb-2">Frecuencia por tipo</h3>
          <canvas id="typeFreqDonut" class="bg-white p-2 rounded w-full" height="200"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Rachas 30m OUT vs IN</h3>
          <canvas id="streaksDivergent" class="bg-white p-2 rounded w-full" height="200"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Tasa de alternancia</h3>
          <canvas id="alternationGauge" class="bg-white p-4 rounded w-full h-48"></canvas>
        </div>
      </div>

      

    <div id="otherCards" class="grid md:grid-cols-3 gap-4 sec-general"></div>
        </div>
      </div>
    </div>
    <footer class="max-w-5xl mx-auto p-4">
      <details class="bg-gray-900 text-gray-100 rounded">
        <summary class="cursor-pointer px-4 py-2 bg-gray-800 text-white rounded">
          Ver JSON crudo
        </summary>
        <pre id="rawJson" class="p-4 overflow-x-auto"></pre>
      </details>
    </footer>

    <!-- Modal: Cargar datos -->
    <div
      id="loadModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50"
      aria-hidden="true"
    >
      <div class="bg-white rounded shadow max-w-3xl w-full p-0 overflow-hidden">
        <div class="px-4 py-3 border-b flex items-center justify-between">
          <h2 class="text-lg font-semibold">Cargar datos</h2>
          <button id="loadCloseBtn" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">✕</button>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <label for="featuresJsonInput" class="block text-sm font-medium mb-1">Features (JSON)</label>
            <textarea id="featuresJsonInput" class="w-full border rounded p-2 font-mono text-sm h-48" placeholder="Pega aquí el JSON de features"></textarea>
          </div>
          <div>
            <label for="txJsonInput" class="block text-sm font-medium mb-1">Transacción (JSON - opcional)</label>
            <textarea id="txJsonInput" class="w-full border rounded p-2 font-mono text-sm h-32" placeholder="Por ahora no se utiliza"></textarea>
          </div>
          <p id="loadError" class="text-sm text-red-600 hidden"></p>
        </div>
        <div class="px-4 py-3 border-t flex items-center justify-end gap-2 bg-gray-50">
          <button id="loadCancelBtn" class="px-4 py-2 rounded border bg-white hover:bg-gray-100">Cancelar</button>
          <button id="loadConfirmBtn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Cargar</button>
        </div>
      </div>
    </div>

    <script>
      // Parse JSON from query param 'p'
      let data = {};
      let rawData = {};
      try {
        const params = new URLSearchParams(window.location.search);
        const p = params.get("p");
        if (p) {
          data = JSON.parse(decodeURIComponent(p));
          rawData = JSON.parse(JSON.stringify(data));
        }
      } catch (e) {
        console.error("Error parsing data", e);
      }

      // Estructura de sets: { sets: { ... } }
      const sets = (data && data.sets) || {};

      function syntaxHighlight(json) {
        if (typeof json !== "string") {
          json = JSON.stringify(json, undefined, 2);
        }
        json = json
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        return json.replace(
          /("(\u[a-zA-Z0-9]{4}|\[^u]|[^\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
          function (match) {
            let cls = "text-green-300";
            if (/^"/.test(match)) {
              cls = /:$/.test(match) ? "text-blue-300" : "text-orange-300";
            } else if (/true|false/.test(match)) {
              cls = "text-purple-300";
            } else if (/null/.test(match)) {
              cls = "text-pink-300";
            } else {
              cls = "text-yellow-300";
            }
            return `<span class="${cls}">${match}</span>`;
          },
        );
      }

      function renderRobustBullet(
        canvasId,
        f,
        { currency = "ARS", title = null } = {},
      ) {
        // Acepta tanto estructura anidada como plana dentro del set
        const med = +((f?.robust_stats?.median_abs) ?? f?.median_abs ?? 0);
        const mad = +((f?.robust_stats?.mad_abs) ?? f?.mad_abs ?? 0);
        const frac = +((f?.robust_stats?.["frac_outlier_z>=3.5"]) ?? f?.["frac_outlier_z>=3.5"] ?? 0);

        const p95 = (f?.totals?.p95_abs ?? f?.p95_abs ?? null);
        const p99 = (f?.totals?.p99_abs ?? f?.p99_abs ?? null);

        const kOut = 3.5 / 0.6745; // ≈ 5.187

        const loTyp = med - 2 * mad;
        const hiTyp = med + 2 * mad;
        const loOut = med - kOut * mad;
        const hiOut = med + kOut * mad;

        const xMin = Math.min(isFinite(loOut) ? loOut : med - 2 * mad, 0, med * 0.8);
        const baseMax = Math.max(
          isFinite(hiOut) ? hiOut : med + 2 * mad,
          med + 2 * mad,
        );
        const xMax = Math.max(baseMax, (p99 ?? baseMax) * 1.1);

        const fmt = new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency,
          maximumFractionDigits: 0,
        });

        const markers = [{ x: med, y: 0.5, label: "Mediana" }];
        if (p95 != null && isFinite(p95)) markers.push({ x: +p95, y: 0.5, label: "P95" });
        if (p99 != null && isFinite(p99)) markers.push({ x: +p99, y: 0.5, label: "P99" });

        const robustBands = {
          id: "robustBands",
          beforeDatasetsDraw(chart) {
            const {
              ctx,
              chartArea,
              scales: { x, y },
            } = chart;
            if (!chartArea) return;

            const y1 = chartArea.top + chartArea.height * 0.4;
            const y2 = chartArea.top + chartArea.height * 0.6;

            const xr = (val) => x.getPixelForValue(val);
            const rect = (from, to, alpha) => {
              if (!isFinite(from) || !isFinite(to)) return;
              const left = xr(Math.min(from, to));
              const width = Math.abs(xr(to) - xr(from));
              ctx.save();
              ctx.globalAlpha = alpha;
              ctx.fillStyle = "#999";
              ctx.fillRect(left, y1, width, y2 - y1);
              ctx.restore();
            };
            const vline = (val, dash = [4, 3]) => {
              if (!isFinite(val)) return;
              const xp = xr(val);
              ctx.save();
              ctx.setLineDash(dash);
              ctx.lineWidth = 1;
              ctx.strokeStyle = "#333";
              ctx.beginPath();
              ctx.moveTo(xp, chartArea.top + 6);
              ctx.lineTo(xp, chartArea.bottom - 6);
              ctx.stroke();
              ctx.restore();
            };

            rect(loOut, hiOut, 0.15);
            rect(loTyp, hiTyp, 0.35);

            vline(med, [6, 3]);
            if (p95 != null) vline(+p95, [4, 4]);
            if (p99 != null) vline(+p99, [2, 3]);
          },
          afterDatasetsDraw(chart) {
            const { ctx, chartArea, scales: { x } } = chart;
            const drawLabel = (val, text) => {
              if (!isFinite(val)) return;
              const xp = x.getPixelForValue(val);
              ctx.save();
              ctx.font = "10px system-ui, -apple-system, Segoe UI, Roboto, Arial";
              ctx.fillStyle = "#111";
              ctx.textAlign = "center";
              ctx.textBaseline = "bottom";
              ctx.fillText(text, xp, chartArea.top + 4);
              ctx.restore();
            };
            drawLabel(med, "Mediana");
            if (p95 != null) drawLabel(+p95, "P95");
            if (p99 != null) drawLabel(+p99, "P99");
          },
        };

        const canvas = document.getElementById(canvasId);
        canvas._chartInstance?.destroy();

        const chart = new Chart(canvas, {
          type: "scatter",
          data: {
            datasets: [
              {
                label: "Marcadores",
                data: markers,
                pointRadius: 4,
                pointHoverRadius: 6,
                showLine: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label(ctx) {
                    const raw = ctx.raw || {};
                    const name = raw.label || "Valor";
                    const val = ctx.parsed?.x;
                    return `${name}: ${fmt.format(val)}`;
                  },
                  title() {
                    return "";
                  },
                },
              },
              title: {
                display: true,
                text:
                  title ||
                  `Escala robusta • outliers ≈ ${(frac * 100).toFixed(1)}%`,
              },
            },
            scales: {
              x: {
                type: "linear",
                suggestedMin: xMin,
                suggestedMax: xMax,
                ticks: {
                  callback: (v) => fmt.format(v),
                },
                grid: { drawOnChartArea: true },
              },
              y: {
                type: "linear",
                min: 0,
                max: 1,
                display: false,
                grid: { display: false },
              },
            },
          },
          plugins: [robustBands],
        });

        canvas._chartInstance = chart;
      }

      function toNum(v) {
        if (v == null) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function fmtDuration(seconds) {
        if (!Number.isFinite(seconds)) return '';
        const sign = seconds < 0 ? '-' : '';
        let s = Math.abs(seconds);
        const d = Math.floor(s / 86400);
        s -= d * 86400;
        const h = Math.floor(s / 3600);
        s -= h * 3600;
        const m = Math.floor(s / 60);
        s -= m * 60;
        const parts = [];
        if (d) parts.push(`${d}d`);
        if (h) parts.push(`${h}h`);
        if (m) parts.push(`${m}m`);
        parts.push(`${Math.floor(s)}s`);
        return sign + parts.join(' ');
      }

      // Recency chart rendered similarly to robust bullet using Chart.js
      function renderRecencyBullet(
        divId,
        f,
        { title = "Recencia • Min–Max y P05–P95 con Mediana/Media" } = {},
      ) {
        const r = (f && f.recency) || {};
        const p05 = toNum(r.p05_delta_s);
        const p95 = toNum(r.p95_delta_s);
        const med = toNum(r.median_delta_s);
        const mean = toNum(r.mean_delta_s);
        const min = toNum(r.min_delta_s);
        const max = toNum(r.max_delta_s);
        const values = [p05, p95, med, mean, min, max].filter((v) => v != null);
        if (!values.length) return;

        const xMin = Math.max(0, Math.min(...values, 0));
        const baseMax = Math.max(...values, 1);
        const xMax = baseMax * 1.1;

        const step = (xMax - xMin) / 4;
        const tickVals = Array.from({ length: 5 }, (_, i) => xMin + i * step);
        const tickText = tickVals.map((v) => fmtDuration(v));

        const data = [];
        if (min != null && max != null) {
          data.push({
            x: [min, max],
            y: [0, 0],
            mode: "lines+markers",
            line: { color: "#ccc", width: 8 },
            marker: { color: "#ccc", size: 12 },
            hoverinfo: "skip",
            showlegend: false,
          });
        }
        if (p05 != null && p95 != null) {
          data.push({
            x: [p05, p95],
            y: [0, 0],
            mode: "lines+markers",
            line: { color: "#999", width: 8 },
            marker: { color: "#999", size: 12 },
            hoverinfo: "skip",
            showlegend: false,
          });
        }

        const shapes = [];
        const annotations = [];

        if (min != null) {
          shapes.push({
            type: "line",
            x0: min,
            x1: min,
            y0: -0.2,
            y1: 0.2,
            line: { color: "#555", width: 2 },
          });
          annotations.push({
            x: min,
            y: -0.25,
            text: "Min",
            showarrow: false,
            yanchor: "top",
            font: { size: 10 },
          });
          data.push({
            x: [min],
            y: [0],
            mode: "markers",
            marker: { size: 1, color: "rgba(0,0,0,0)" },
            hovertemplate: `Min: ${fmtDuration(min)}<extra></extra>`,
            showlegend: false,
          });
        }
        if (p05 != null) {
          shapes.push({
            type: "line",
            x0: p05,
            x1: p05,
            y0: -0.2,
            y1: 0.2,
            line: { color: "#999", width: 2, dash: "dot" },
          });
          annotations.push({
            x: p05,
            y: -0.25,
            text: "P5",
            showarrow: false,
            yanchor: "top",
            font: { size: 10 },
          });
          data.push({
            x: [p05],
            y: [0],
            mode: "markers",
            marker: { size: 1, color: "rgba(0,0,0,0)" },
            hovertemplate: `P5: ${fmtDuration(p05)}<extra></extra>`,
            showlegend: false,
          });
        }
        if (p95 != null) {
          shapes.push({
            type: "line",
            x0: p95,
            x1: p95,
            y0: -0.2,
            y1: 0.2,
            line: { color: "#999", width: 2, dash: "dot" },
          });
          annotations.push({
            x: p95,
            y: -0.25,
            text: "P95",
            showarrow: false,
            yanchor: "top",
            font: { size: 10 },
          });
          data.push({
            x: [p95],
            y: [0],
            mode: "markers",
            marker: { size: 1, color: "rgba(0,0,0,0)" },
            hovertemplate: `P95: ${fmtDuration(p95)}<extra></extra>`,
            showlegend: false,
          });
        }
        if (max != null) {
          shapes.push({
            type: "line",
            x0: max,
            x1: max,
            y0: -0.2,
            y1: 0.2,
            line: { color: "#555", width: 2 },
          });
          annotations.push({
            x: max,
            y: -0.25,
            text: "Max",
            showarrow: false,
            yanchor: "top",
            font: { size: 10 },
          });
          data.push({
            x: [max],
            y: [0],
            mode: "markers",
            marker: { size: 1, color: "rgba(0,0,0,0)" },
            hovertemplate: `Max: ${fmtDuration(max)}<extra></extra>`,
            showlegend: false,
          });
        }
        if (med != null) {
          shapes.push({
            type: "line",
            x0: med,
            x1: med,
            y0: -0.2,
            y1: 0.2,
            line: { color: "#111", width: 2, dash: "dash" },
          });
          annotations.push({
            x: med,
            y: 0.25,
            text: "Mediana",
            showarrow: false,
            yanchor: "bottom",
            font: { size: 10 },
          });
          data.push({
            x: [med],
            y: [0],
            mode: "markers",
            marker: { size: 1, color: "rgba(0,0,0,0)" },
            hovertemplate: `Mediana: ${fmtDuration(med)}<extra></extra>`,
            showlegend: false,
          });
        }
        if (mean != null) {
          shapes.push({
            type: "line",
            x0: mean,
            x1: mean,
            y0: -0.2,
            y1: 0.2,
            line: { color: "#111", width: 2, dash: "dot" },
          });
          annotations.push({
            x: mean,
            y: 0.25,
            text: "Media",
            showarrow: false,
            yanchor: "bottom",
            font: { size: 10 },
          });
          data.push({
            x: [mean],
            y: [0],
            mode: "markers",
            marker: { size: 1, color: "rgba(0,0,0,0)" },
            hovertemplate: `Media: ${fmtDuration(mean)}<extra></extra>`,
            showlegend: false,
          });
        }

        Plotly.react(
          divId,
          data,
          {
            title: { text: title },
            shapes,
            annotations,
            xaxis: {
              range: [xMin, xMax],
              tickmode: "array",
              tickvals: tickVals,
              ticktext: tickText,
              zeroline: false,
            },
            yaxis: { range: [-0.5, 0.5], visible: false },
            margin: { l: 40, r: 20, t: 40, b: 40 },
            height: 200,
            hovermode: "x",
          },
          { displayModeBar: false },
        );
      }

      const LABELS = {
        tier: "Tier por volumen (1=alto, 5=bajo)",
        totals: {
          n_trx: "Operaciones (90 días) (#)",
          sum_in: "Ingresos ($)",
          sum_out: "Egresos ($)",
          net: "Neto ($)",
          median_abs: "Mediana de monto ($)",
          mad_abs: "MAD (desvío abs. mediano) ($)",
          "frac_outlier_z>=3.5": "% outliers (z robusto ≥ 3.5) (%)",
          max_abs: "Monto máximo ($)",
          p95_abs: "P95 de monto ($)",
          p99_abs: "P99 de monto ($)",
        },
        robust_stats: {
          median_abs: "Mediana de monto ($)",
          mad_abs: "MAD ($)",
          "frac_outlier_z>=3.5": "% outliers robustos (%)",
        },
        velocity: {
          max_cnt_5m: "Máx. ops en 5 min (#)",
          max_cnt_30m: "Máx. ops en 30 min (#)",
          max_cnt_60m: "Máx. ops en 60 min (#)",
          max_cnt_24h: "Máx. ops en 24 h (#)",
        },
        recency: {
          mean_delta_s: "Δt promedio entre ops (seg)",
          median_delta_s: "Δt mediano (seg)",
          p05_delta_s: "Δt P5 (seg)",
          p95_delta_s: "Δt P95 (seg)",
          min_delta_s: "Δt mínimo (seg)",
          max_delta_s: "Δt máximo (seg)",
        },
        novelty: {
          first_time_cbu_frac: "% CBUs nuevos (%)",
          first_time_cuit_frac: "% CUITs nuevos (%)",
          rare_cbu_frac: "% CBUs raros (<2 tx) (%)",
          rare_cuit_frac: "% CUITs raros (<2 tx) (%)",
          new_cbu_count: "CBUs nuevos (#)",
          new_cuit_count: "CUITs nuevos (#)",
        },
        temporal: {
          hour_jsd_vs_uniform: "Desvío horario vs uniforme (JSD) (0–~0.7)",
          hour_peak_ratio: "% en hora pico (% del total en la hora más activa)",
          weekend_frac: "% en fin de semana (%)",
        },
        roundness: {
          pct_amt_mod_100_eq_0: "% montos múltiplos de $100 (%)",
          pct_amt_mod_1000_eq_0: "% montos múltiplos de $1.000 (%)",
          last_digit_hist: "Último dígito del monto (histograma 0–9)",
        },
        streaks: {
          max_in_30m: "Racha IN en 30 min (máx) (#)",
          max_out_30m: "Racha OUT en 30 min (máx) (#)",
          alternation_rate: "Tasa de alternancia IN↔OUT (0–1)",
        },
        location: {
          unique_checkout: "Checkouts únicos (#)",
          checkout_changes: "Cambios de checkout (#)",
          unique_branch: "Sucursales únicas (#)",
          branch_changes: "Cambios de sucursal (#)",
        },
        duplicates: {
          dup_close_10min_count: "Duplicados ≤10 min (#)",
        },
        status: {
          fail_ratio_overall: "% operaciones fallidas (%)",
          max_fail_ratio_24h: "Máx. % fallidas en 24 h (%)",
        },
        flow: {
          n_in: "Operaciones IN (#)",
          n_out: "Operaciones OUT (#)",
          in_ratio_count: "% IN por cantidad (%)",
          in_ratio_amount: "% IN por monto (%)",
        },
        coherence: {
          dir_unknown_count: "Operaciones sin dirección (#)",
          dir_coverage: "Cobertura de dirección (0–1)",
          in_ratio_count_dir: "IN% (cantidad) por direction (%)",
          in_ratio_count_type: "IN% (cantidad) por tipo (%)",
          in_ratio_count_diff: "Δ IN% (cantidad) dir vs tipo (pp)",
          in_ratio_amount_dir: "IN% (monto) por direction (%)",
          in_ratio_amount_type: "IN% (monto) por tipo (%)",
          in_ratio_amount_diff: "Δ IN% (monto) dir vs tipo (pp)",
          n_rows_used_for_type: "Filas con tipo mapeable (#)",
        },
      };

      function formatNumber(num) {
        if (typeof num === "number") {
          return num.toLocaleString("es-AR", { maximumFractionDigits: 2 });
        }
        if (typeof num === "object") {
          return JSON.stringify(num);
        }
        return num;
      }

      const ICONS = {
        operaciones:
          "<path stroke-linecap='round' stroke-linejoin='round' d='M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z' />",
        ingresos:
          "<path stroke-linecap='round' stroke-linejoin='round' d='m9 12.75 3 3m0 0 3-3m-3 3v-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z' />",
        egresos:
          "<path stroke-linecap='round' stroke-linejoin='round' d='m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z' />",
        neto:
          "<path stroke-linecap='round' stroke-linejoin='round' d='M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 0 1-2.031.352 5.988 5.988 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971Zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 0 1-2.031.352 5.989 5.989 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971Z' />",
      };

      function addTopCard(containerId, label, value, icon, color) {
        const container = document.getElementById(containerId);
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow flex items-center";
        card.innerHTML =
          `<svg class='w-8 h-8 ${color} mr-3' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' xmlns='http://www.w3.org/2000/svg'>${icon}</svg>` +
          `<div><p class='text-sm text-gray-500'>${label}</p><p class='text-lg font-semibold'>${formatNumber(value)}</p></div>`;
        container.appendChild(card);
      }

      function addCard(containerId, title, obj, labels = {}) {
        const entries = Object.entries(obj || {});
        if (!entries.length) return;
        const container = document.getElementById(containerId);
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow";
        let html = `<h5 class="text-lg font-semibold mb-2">${title}</h5>`;
        html += entries
          .map(
            ([k, v]) =>
              `<p class='text-sm'><span class='font-medium'>${labels[k] || k}:</span> ${formatNumber(v)}</p>`,
          )
          .join("");
        card.innerHTML = html;
        container.appendChild(card);
      }

      function setTierMeta(g) {
        const dashboard = document.getElementById("dashboard");
        const h1 = dashboard.querySelector("h1");
        let meta = document.getElementById('setMeta');
        if (!meta) {
          meta = document.createElement('p');
          meta.id = 'setMeta';
          h1.insertAdjacentElement('afterend', meta);
        }
        const tierText = (g && g.tier != null) ? `${formatNumber(g.tier)}` : 'N/D';
        meta.innerHTML = `<strong>${LABELS.tier}:</strong> ${tierText}`;
      }

      function clearContainers() {
        const ids = ['topCards', 'otherCards'];
        ids.forEach((id) => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });
        // Destroy chart instances if present
        ['hourChart','velocityBurstChart','typeFreqDonut','streaksDivergent','robustBullet'].forEach((id) => {
          const c = document.getElementById(id);
          if (c && c._chartInstance) { try { c._chartInstance.destroy(); } catch(e){} }
        });
      }

      function chartOn(canvasId, cfg) {
        const c = document.getElementById(canvasId);
        if (!c) return null;
        if (c._chartInstance) { try { c._chartInstance.destroy(); } catch(e){} }
        const ch = new Chart(c, cfg);
        c._chartInstance = ch;
        return ch;
      }

      function renderAll(general) {
        clearContainers();
        setTierMeta(general);

      if (general.totals) {
          addTopCard(
            "topCards",
            "Operaciones",
            general.totals.n_trx,
            ICONS.operaciones,
            "text-blue-500",
          );
          addTopCard(
            "topCards",
            "Ingresos",
            general.totals.sum_in,
            ICONS.ingresos,
            "text-green-500",
          );
          addTopCard(
            "topCards",
            "Egresos",
            general.totals.sum_out,
            ICONS.egresos,
            "text-red-500",
          );
          addTopCard("topCards", "Neto", general.totals.net, ICONS.neto, "text-gray-500");
        } else if (typeof general.n_trx === 'number') {
          addTopCard(
            "topCards",
            "Operaciones",
            general.n_trx,
            ICONS.operaciones,
            "text-blue-500",
          );
        }

      if (general.robust_stats || general.median_abs != null || general.p95_abs != null) {
        renderRobustBullet("robustBullet", general, { currency: "ARS" });
      }

      if (general.temporal && general.temporal.hour_hist) {
        const hist = general.temporal.hour_hist;
        const hours = Object.keys(hist)
          .map((h) => parseInt(h))
          .sort((a, b) => a - b);
        const counts = hours.map((h) => hist[h]);
        chartOn("hourChart", {
          type: "bar",
          data: {
            labels: hours,
            datasets: [
              {
                label: "Operaciones",
                data: counts,
                backgroundColor: "#0d6efd",
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
      }

      if (general.velocity) {
        const v = general.velocity;
        const vLabels = ["5m", "30m", "60m", "24h"];
        const vValues = [
          v.max_cnt_5m,
          v.max_cnt_30m,
          v.max_cnt_60m,
          v.max_cnt_24h,
        ];
        chartOn("velocityBurstChart", {
          type: "bar",
          data: {
            labels: vLabels,
            datasets: [
              {
                label: "Ráfagas",
                data: vValues,
                backgroundColor: "#f59e0b",
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
      }

      if (general.type_freq) {
        const tfLabels = Object.keys(general.type_freq);
        const tfValues = tfLabels.map((k) => general.type_freq[k]);
        chartOn("typeFreqDonut", {
          type: "doughnut",
          data: {
            labels: tfLabels,
            datasets: [
              {
                data: tfValues,
                backgroundColor: [
                  "#3b82f6",
                  "#10b981",
                  "#f59e0b",
                  "#ef4444",
                  "#6366f1",
                ],
              },
            ],
          },
          options: { plugins: { legend: { position: "bottom" } } },
        });
      }

      // Todas las visualizaciones dependen del set seleccionado (renderAll)

      if (general.recency && general.recency.delta_hist) {
        delete general.recency.delta_hist;
      }
        if (general.recency) {
          renderRecencyBullet('recencyBullet', general, {
            title: 'Recencia • Min–Max y P05–P95 con Mediana/Media'
          });
        }

      if (general.streaks) {
        const s = general.streaks;
        const maxVal = Math.max(s.max_in_30m || 0, s.max_out_30m || 0);
        chartOn("streaksDivergent", {
          type: "bar",
          data: {
            labels: [""],
            datasets: [
              {
                label: "OUT",
                data: [-(s.max_out_30m || 0)],
                backgroundColor: "#ef4444",
              },
              {
                label: "IN",
                data: [s.max_in_30m || 0],
                backgroundColor: "#10b981",
              },
            ],
          },
          options: {
            indexAxis: "y",
            scales: {
              x: { min: -maxVal, max: maxVal, ticks: { precision: 0 } },
              y: { stacked: true, display: false },
            },
            plugins: { legend: { display: false } },
          },
        });

          const gaugeCanvas = document.getElementById("alternationGauge");
          const gaugeOpts = {
            angle: 0,
            lineWidth: 0.2,
            radiusScale: 1,
            pointer: { length: 0.6, strokeWidth: 0.035, color: "#111827" },
            limitMax: true,
            limitMin: true,
            strokeColor: "#E5E7EB",
            staticZones: [
              { strokeStyle: "#10b981", min: 0, max: 0.33 },
              { strokeStyle: "#f59e0b", min: 0.33, max: 0.66 },
              { strokeStyle: "#ef4444", min: 0.66, max: 1 },
            ],
            staticLabels: {
              font: "10px sans-serif",
              labels: [0, 0.5, 1],
              fractionDigits: 2,
            },
          };
          const gauge = new Gauge(gaugeCanvas).setOptions(gaugeOpts);
          gauge.maxValue = 1;
          gauge.setMinValue(0);
          gauge.animationSpeed = 32;
          gauge.set(s.alternation_rate || 0);
        }

        if (general.temporal) {
        const temporalData = { ...general.temporal };
        delete temporalData.hour_hist;
        addCard("otherCards", "Temporal", temporalData, LABELS.temporal);
      }

      if (general.robust_stats)
        addCard(
          "otherCards",
          "Estadísticas robustas",
          general.robust_stats,
          LABELS.robust_stats,
        );
      //if (data.velocity)
      //  addCard("otherCards", "Velocidad", data.velocity, LABELS.velocity);
      if (general.recency)
        addCard("otherCards", "Recencia", general.recency, LABELS.recency);
      if (general.novelty)
        addCard("otherCards", "Novedad", general.novelty, LABELS.novelty);
      //if (data.type_freq)
      //  addCard("otherCards", "Frecuencia por tipo", data.type_freq);
      //if (data.type_group_freq)
      //  addCard(
      //    "otherCards",
       //   "Frecuencia por grupo de tipo",
       //   data.type_group_freq,
       // );
      if (general.roundness)
        addCard("otherCards", "Redondez", general.roundness, LABELS.roundness);
      //if (data.streaks)
      //  addCard("otherCards", "Rachas", data.streaks, LABELS.streaks);
      if (general.location)
        addCard("otherCards", "Ubicación", general.location, LABELS.location);
      if (general.flow) addCard("otherCards", "Flujo", general.flow, LABELS.flow);
      //if (data.coherence)
      //  addCard("otherCards", "Coherencia", data.coherence, LABELS.coherence);
      if (general.status)
        addCard("otherCards", "Estado", general.status, LABELS.status);
      if (general.duplicates)
        addCard("otherCards", "Duplicados", general.duplicates, LABELS.duplicates);

      }

      const rawPre = document.getElementById("rawJson");
      if (rawPre) {
        rawPre.innerHTML = syntaxHighlight(rawData);
      }

      function formatSetLabel(key) {
        if (key === 'global') return 'Global';
        if (key.startsWith('by_direction_')) {
          const name = key.replace('by_direction_', '');
          return 'Por dirección: ' + name.charAt(0).toUpperCase() + name.slice(1);
        }
        if (key.startsWith('by_type_')) {
          const name = key.replace('by_type_', '');
          return 'Por tipo: ' + name.charAt(0).toUpperCase() + name.slice(1);
        }
        return key;
      }
      function selectSet(key) {
        // button active state
        document.querySelectorAll('#sidebarNav [data-set]').forEach((btn) => {
          btn.classList.remove('bg-gray-200', 'text-gray-900');
        });
        const active = document.querySelector(`#sidebarNav [data-set="${key}"]`);
        if (active) active.classList.add('bg-gray-200', 'text-gray-900');
        const s = sets[key] || {};
        renderAll(s);
        try { window.dispatchEvent(new Event('resize')); } catch (e) {}
        if (window.Plotly && document.getElementById('recencyBullet')) {
          try { Plotly.Plots.resize('recencyBullet'); } catch (e) {}
        }
      }
      function setupSidebar() {
        const nav = document.getElementById('sidebarNav');
        // Cargar datos button
        const loadBtn = document.createElement('button');
        loadBtn.type = 'button';
        loadBtn.id = 'openLoadBtn';
        loadBtn.className = 'w-full text-left px-4 py-2 hover:bg-gray-100 border-b';
        loadBtn.textContent = 'Cargar datos';
        nav.appendChild(loadBtn);

        const keys = Object.keys(sets || {});
        keys.sort((a, b) => (a === 'global' ? -1 : b === 'global' ? 1 : a.localeCompare(b)));
        keys.forEach((key) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.set = key;
          btn.className = 'w-full text-left px-4 py-2 hover:bg-gray-100';
          btn.textContent = formatSetLabel(key);
          btn.addEventListener('click', () => selectSet(key));
          nav.appendChild(btn);
        });
        const defaultKey = keys.includes('global') ? 'global' : (keys[0] || null);
        if (defaultKey) selectSet(defaultKey);
      }
      setupSidebar();

      // Modal handlers
      (function setupLoadModal() {
        const modal = document.getElementById('loadModal');
        const openBtn = document.getElementById('openLoadBtn');
        const closeBtn = document.getElementById('loadCloseBtn');
        const cancelBtn = document.getElementById('loadCancelBtn');
        const confirmBtn = document.getElementById('loadConfirmBtn');
        const featuresInput = document.getElementById('featuresJsonInput');
        const txInput = document.getElementById('txJsonInput');
        const errorEl = document.getElementById('loadError');

        function openModal() {
          errorEl.classList.add('hidden');
          errorEl.textContent = '';
          try {
            featuresInput.value = rawData && Object.keys(rawData).length ? JSON.stringify(rawData, null, 2) : '';
          } catch (e) { featuresInput.value = ''; }
          txInput.value = '';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }
        function closeModal() {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }
        function loadData() {
          errorEl.classList.add('hidden');
          errorEl.textContent = '';
          const txt = featuresInput.value.trim();
          if (!txt) { closeModal(); return; }
          try {
            const parsed = JSON.parse(txt);
            const url = new URL(window.location.href);
            url.searchParams.set('p', encodeURIComponent(JSON.stringify(parsed)));
            window.location.href = url.toString();
          } catch (e) {
            errorEl.textContent = 'JSON inválido en Features: ' + (e?.message || e);
            errorEl.classList.remove('hidden');
          }
        }

        if (openBtn) openBtn.addEventListener('click', openModal);
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
        if (confirmBtn) confirmBtn.addEventListener('click', loadData);
        // Close on backdrop click
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        // Escape to close
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
      })();
    </script>
  </body>
</html>
